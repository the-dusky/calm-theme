{% comment %}
  Drop system helper functions for preorder management
  
  Usage:
  {% capture is_drop_result %}{% render 'drop-helpers', product: product, action: 'is_drop_product' %}{% endcapture %}
  {% assign is_drop_product = is_drop_result | strip %}
  
  {% capture drop_info_result %}{% render 'drop-helpers', product: product, action: 'get_drop_info' %}{% endcapture %}
  {% assign drop_info_handle = drop_info_result | strip %}
{% endcomment %}

{% liquid
  case action
    when 'is_drop_product'
      # Check if product belongs to any collection with drop metafields
      for collection in product.collections
        if collection.metafields.custom.ship_by_date != blank or collection.metafields.custom.drop_location != blank
          echo 'true'
          break
        endif
      endfor
      
    when 'get_drop_info'
      # Get drop information from the first collection with drop metafields
      for collection in product.collections
        if collection.metafields.custom.ship_by_date != blank or collection.metafields.custom.drop_location != blank
          echo collection.handle
          break
        endif
      endfor
      
    when 'format_drop_name'
      # Format collection name for display: "US Drop - Ships March 15"
      assign drop_name = collection.title
      if collection.metafields.custom.drop_location != blank
        assign drop_name = collection.metafields.custom.drop_location | append: ' Drop'
      endif
      if collection.metafields.custom.ship_by_date != blank
        assign ship_date = collection.metafields.custom.ship_by_date | date: '%B %d'
        assign drop_name = drop_name | append: ' - Ships ' | append: ship_date
      endif
      echo drop_name
      
    when 'is_variant_sold_out'
      # Check if variant is marked as sold out
      if variant.metafields.custom.is_sold_out == true
        echo 'true'
      else
        echo 'false'
      endif
      
    when 'get_expected_delivery'
      # Calculate expected delivery date (ship_by_date + 7 days)
      if collection.metafields.custom.ship_by_date != blank
        assign ship_date = collection.metafields.custom.ship_by_date
        assign delivery_timestamp = ship_date | date: '%s' | plus: 604800
        echo delivery_timestamp | date: '%B %d'
      endif
      
    when 'get_availability_status'
      # Get availability status for a product: available, future, or closed
      assign now = 'now' | date: '%s'
      assign has_available_drop = false
      assign has_future_drop = false
      
      for collection in product.collections
        if collection.metafields.custom.ship_by_date != blank
          assign cutoff_date = collection.metafields.custom.order_cutoff_date
          if cutoff_date != blank
            assign cutoff_timestamp = cutoff_date | date: '%s'
            if now <= cutoff_timestamp
              assign has_available_drop = true
            else
              assign has_future_drop = true
            endif
          else
            assign has_available_drop = true
          endif
        endif
      endfor
      
      if has_available_drop
        echo 'available'
      elsif has_future_drop
        echo 'future'
      else
        echo 'closed'
      endif
  endcase
%}